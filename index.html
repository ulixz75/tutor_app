<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tutor IA Interactivo 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --background-start-rgb: 15, 23, 42;
        --background-end-rgb: 49, 46, 129;
        --glass-bg: rgba(30, 41, 59, 0.7);
        --border-color: rgba(255, 255, 255, 0.1);
        --accent-color: #6366f1;
      }

      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(
          135deg,
          rgb(var(--background-start-rgb)),
          rgb(var(--background-end-rgb))
        );
      }

      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.4);
      }

      .glass-pane {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--border-color);
      }

      .typing-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        margin: 0 2px;
        background-color: #9ca3af;
        border-radius: 50%;
        animation: typing 1.4s infinite both;
      }

      .typing-indicator span:nth-child(1) {
        animation-delay: 0.2s;
      }

      .typing-indicator span:nth-child(2) {
        animation-delay: 0.4s;
      }

      .typing-indicator span:nth-child(3) {
        animation-delay: 0.6s;
      }

      @keyframes typing {
        0%,
        100% {
          opacity: 0.2;
          transform: scale(0.8);
        }

        40% {
          opacity: 1;
          transform: scale(1);
        }
      }

      @keyframes fade-in {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }

      @keyframes slide-up {
        from {
          opacity: 0;
          transform: translateY(15px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fade-in {
        animation: fade-in 0.5s ease-in-out forwards;
      }

      .animate-slide-up {
        animation: slide-up 0.5s ease-in-out forwards;
      }

      .prompt-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
      }

      .prompt-card:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-5px);
        border-color: var(--accent-color);
      }

      .suggestion-chip {
        background: rgba(79, 70, 229, 0.2);
        border: 1px solid rgba(79, 70, 229, 0.8);
        color: #c7d2fe;
        transition: all 0.2s ease;
      }

      .suggestion-chip:hover {
        background: rgba(79, 70, 229, 0.4);
        color: #fff;
      }

      .quiz-container {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .quiz-question {
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .quiz-option {
        display: block;
        width: 100%;
        text-align: left;
        padding: 0.5rem;
        margin-bottom: 0.25rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.2s ease;
        color: inherit;
      }

      .quiz-option:hover {
        background: rgba(79, 70, 229, 0.2);
      }

      .quiz-option.selected {
        background: rgba(79, 70, 229, 0.4);
        border-color: var(--accent-color);
      }

      .quiz-results {
        margin-top: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 0.5rem;
        border: 1px solid var(--border-color);
      }

      .correct-answer {
        color: #10b981;
      }

      .incorrect-answer {
        color: #ef4444;
      }

      .quiz-score {
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 1rem;
      }
    </style>
  </head>

  <body class="text-slate-200 font-sans antialiased">
    <div class="flex flex-col md:flex-row h-screen">
      <div
        class="md:hidden glass-pane p-4 flex justify-between items-center border-b border-slate-700/50"
      >
        <h1
          class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400"
        >
          NABORI Tutor IA
        </h1>
        <button id="menu-toggle" class="text-slate-300 hover:text-white">
          <i class="fas fa-bars text-2xl"></i>
        </button>
      </div>

      <aside
        id="sidebar"
        class="glass-pane w-64 flex-shrink-0 p-4 flex-col hidden md:flex absolute md:relative h-full z-50"
      >
        <div class="flex items-center gap-3 mb-6">
          <i class="fas fa-brain text-3xl text-indigo-400"></i>
          <h1
            class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400"
          >
            NABORI Tutor
          </h1>
        </div>
        <button
          id="new-chat-btn"
          class="w-full text-left bg-indigo-600 hover:bg-indigo-500 rounded-lg p-3 mb-2 transition-colors duration-200 font-semibold shadow-lg shadow-indigo-600/20"
        >
          <i class="fas fa-plus mr-2"></i> Nuevo Chat
        </button>
        <button
          id="quiz-btn"
          class="w-full text-left bg-purple-600 hover:bg-purple-500 rounded-lg p-3 mb-4 transition-colors duration-200 font-semibold shadow-lg shadow-purple-600/20"
        >
          <i class="fas fa-question-circle mr-2"></i> Generar Quiz
        </button>
        <h2
          class="text-xs text-slate-400 font-semibold mb-2 px-2 uppercase tracking-wider"
        >
          Historial
        </h2>
        <div
          id="history-container"
          class="flex-grow overflow-y-auto pr-2"
        ></div>
        <div class="border-t border-slate-700 pt-4 text-sm mt-4">
          <div
            id="user-info"
            class="p-2 text-slate-400 flex items-center gap-2"
          >
            <i class="fas fa-spinner fa-spin"></i> Cargando usuario...
          </div>
        </div>
      </aside>

      <main class="flex-1 flex flex-col bg-slate-800/50">
        <div
          id="subject-selector"
          class="flex justify-center items-center flex-wrap gap-2 md:gap-3 p-3 md:p-4 border-b border-slate-700/50 text-sm md:text-base"
        >
          <span class="font-bold mr-2 md:mr-4 text-slate-300">Materias:</span>
          <button
            data-subject="Matemáticas"
            class="subject-btn bg-indigo-600 hover:bg-indigo-500 px-3 py-1 md:px-4 md:py-2 rounded-full transition-transform transform hover:scale-105 font-semibold"
          >
            📊 Matemáticas
          </button>
          <button
            data-subject="Ciencias"
            class="subject-btn bg-teal-600 hover:bg-teal-500 px-3 py-1 md:px-4 md:py-2 rounded-full transition-transform transform hover:scale-105 font-semibold"
          >
            🔬 Ciencias
          </button>
          <button
            data-subject="Historia"
            class="subject-btn bg-amber-600 hover:bg-amber-500 px-3 py-1 md:px-4 md:py-2 rounded-full transition-transform transform hover:scale-105 font-semibold"
          >
            🏛️ Historia
          </button>
          <button
            data-subject="Literatura"
            class="subject-btn bg-rose-600 hover:bg-rose-500 px-3 py-1 md:px-4 md:py-2 rounded-full transition-transform transform hover:scale-105 font-semibold"
          >
            📚 Literatura
          </button>
          <button
            data-subject="Inglés"
            class="subject-btn bg-sky-600 hover:bg-sky-500 px-3 py-1 md:px-4 md:py-2 rounded-full transition-transform transform hover:scale-105 font-semibold"
          >
            🌍 Inglés
          </button>
        </div>

        <div
          id="progress-indicator"
          class="bg-slate-700/50 p-3 border-b border-slate-700/50 hidden"
        >
          <div class="max-w-4xl mx-auto flex items-center gap-4">
            <span class="text-xs md:text-sm text-slate-300"
              >Progreso de la sesión:</span
            >
            <div class="flex-1 bg-slate-600 rounded-full h-2 shadow-inner">
              <div
                id="progress-bar"
                class="bg-gradient-to-r from-indigo-500 to-purple-500 h-2 rounded-full transition-all duration-300"
                style="width: 0%"
              ></div>
            </div>
            <span
              id="interaction-count"
              class="text-xs md:text-sm text-slate-400 w-24 text-right"
              >0 interacciones</span
            >
          </div>
        </div>

        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6">
          <div
            id="welcome-message"
            class="text-center text-slate-400 animate-fade-in"
          >
            <div class="inline-block p-4 bg-indigo-500/20 rounded-full mb-4">
              <i class="fas fa-robot text-6xl text-indigo-400"></i>
            </div>
            <h1 class="text-2xl md:text-4xl font-bold mb-4 text-slate-100">
              NABORI Corp-Tutor IA
            </h1>
            <p class="text-base md:text-lg mb-8">
              Selecciona una materia para comenzar tu aventura de aprendizaje 🚀
            </p>

            <div
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-w-4xl mx-auto"
            >
              <div
                class="prompt-card rounded-lg p-4 cursor-pointer"
                data-prompt="Explícame qué es una ecuación de primer grado"
                data-subject="Matemáticas"
              >
                <h3 class="font-semibold text-slate-200">
                  📊 ¿Qué es una ecuación?
                </h3>
                <p class="text-sm text-slate-400">
                  Una explicación simple para empezar en álgebra.
                </p>
              </div>
              <div
                class="prompt-card rounded-lg p-4 cursor-pointer"
                data-prompt="¿Cuáles son las partes de una célula?"
                data-subject="Ciencias"
              >
                <h3 class="font-semibold text-slate-200">
                  🔬 Las partes de la célula
                </h3>
                <p class="text-sm text-slate-400">
                  Un resumen de la biología celular básica.
                </p>
              </div>
              <div
                class="prompt-card rounded-lg p-4 cursor-pointer"
                data-prompt="Cuéntame sobre la Revolución Francesa"
                data-subject="Historia"
              >
                <h3 class="font-semibold text-slate-200">
                  🏛️ La Revolución Francesa
                </h3>
                <p class="text-sm text-slate-400">
                  Causas y consecuencias del evento histórico.
                </p>
              </div>
              <div
                class="prompt-card rounded-lg p-4 cursor-pointer"
                data-prompt="Analiza el tema principal de 'Don Quijote de la Mancha'"
                data-subject="Literatura"
              >
                <h3 class="font-semibold text-slate-200">
                  📚 Analizar 'Don Quijote'
                </h3>
                <p class="text-sm text-slate-400">
                  Descubre los temas de la obra maestra.
                </p>
              </div>
              <div
                class="prompt-card rounded-lg p-4 cursor-pointer"
                data-prompt="¿Cómo se usa el 'present perfect' en inglés?"
                data-subject="Inglés"
              >
                <h3 class="font-semibold text-slate-200">
                  🌍 Uso del 'Present Perfect'
                </h3>
                <p class="text-sm text-slate-400">
                  Reglas y ejemplos prácticos de gramática.
                </p>
              </div>
              <div
                class="prompt-card rounded-lg p-4 cursor-pointer"
                data-prompt="Ayúdame a resolver un problema de porcentajes"
                data-subject="Matemáticas"
              >
                <h3 class="font-semibold text-slate-200">
                  🧮 Resolver un problema
                </h3>
                <p class="text-sm text-slate-400">
                  Pide ayuda con un ejercicio específico.
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="p-4 md:p-6 bg-slate-800/50 border-t border-slate-700/50">
          <form id="chat-form" class="relative max-w-4xl mx-auto">
            <textarea
              id="chat-input"
              class="w-full bg-slate-700/80 rounded-lg p-3 md:p-4 pr-12 resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm md:text-base placeholder-slate-400"
              placeholder="Escribe tu pregunta aquí..."
              rows="1"
            ></textarea>
            <button
              type="submit"
              class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-indigo-400 transition-colors w-8 h-8 flex items-center justify-center"
            >
              <i class="fas fa-paper-plane text-lg md:text-xl"></i>
            </button>
          </form>
        </div>
      </main>
    </div>

    <div
      id="quiz-modal"
      class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden"
    >
      <div class="glass-pane rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold mb-4">Generar Quiz</h3>
        <p class="text-slate-400 mb-4">
          Ingresa el tema para generar un quiz de 10 preguntas:
        </p>
        <input
          type="text"
          id="quiz-topic"
          class="w-full bg-slate-700/80 rounded-lg p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          placeholder="Ej: Ecuaciones de primer grado"
        />
        <div class="flex justify-end gap-2">
          <button
            id="cancel-quiz"
            class="px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-500"
          >
            Cancelar
          </button>
          <button
            id="generate-quiz"
            class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500"
          >
            Generar
          </button>
        </div>
      </div>
    </div>

    <div
      id="name-modal"
      class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden"
    >
      <div class="glass-pane rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold mb-4">¡Bienvenido/a!</h3>
        <p class="text-slate-400 mb-4">
          Por favor, ingresa tu nombre completo para personalizar tu
          experiencia.
        </p>
        <form id="name-form">
          <input
            type="text"
            id="name-input"
            class="w-full bg-slate-700/80 rounded-lg p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="Ej: Juan Pérez"
            required
          />
          <div class="flex justify-end">
            <button
              type="submit"
              id="save-name"
              class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500"
            >
              Guardar Nombre
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      // Importaciones de Firebase
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        addDoc,
        collection,
        onSnapshot,
        query,
        serverTimestamp,
        orderBy,
        getDoc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // CONFIGURACIÓN DE FIREBASE
      const firebaseConfig = {
        apiKey: "AIzaSyAOj7-jinNBhD05ewDMM-QFos_oaIVvCyU",
        authDomain: "tutor-ia-escolar.firebaseapp.com",
        projectId: "tutor-ia-escolar",
        storageBucket: "tutor-ia-escolar.firebasestorage.app",
        messagingSenderId: "584016693594",
        appId: "1:584016693594:web:9bc6cee5dbfb05de7c8b63",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // API de Google Gemini
      const GEMINI_API_KEY = "AIzaSyCOTXVkMgadWJrCjLtfUyXzK5yLpebvIMI";

      // VARIABLES GLOBALES Y ESTADO
      let userId = null;
      let currentChatId = null;
      let selectedSubject = null;
      let unsubscribeMessages = null;
      let interactionCount = 0;
      let currentQuiz = null;
      let userQuizAnswers = {};
      let isTypingEffectInProgress = false;
      let chatHistoryBeforeQuiz = null;
      let conversationHistory = []; // Nueva variable para mantener el historial de conversación

      // ELEMENTOS DEL DOM
      const chatContainer = document.getElementById("chat-container");
      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");
      const newChatBtn = document.getElementById("new-chat-btn");
      const quizBtn = document.getElementById("quiz-btn");
      const historyContainer = document.getElementById("history-container");
      const subjectButtons = document.querySelectorAll(".subject-btn");
      const welcomeMessage = document.getElementById("welcome-message");
      const userInfo = document.getElementById("user-info");
      const progressIndicator = document.getElementById("progress-indicator");
      const progressBar = document.getElementById("progress-bar");
      const interactionCountElement =
        document.getElementById("interaction-count");
      const promptCards = document.querySelectorAll(".prompt-card");
      const quizModal = document.getElementById("quiz-modal");
      const quizTopicInput = document.getElementById("quiz-topic");
      const generateQuizBtn = document.getElementById("generate-quiz");
      const cancelQuizBtn = document.getElementById("cancel-quiz");
      const menuToggle = document.getElementById("menu-toggle");
      const sidebar = document.getElementById("sidebar");
      const nameModal = document.getElementById("name-modal");
      const nameForm = document.getElementById("name-form");
      const nameInput = document.getElementById("name-input");

      // AUTENTICACIÓN
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
          loadChatHistory();

          const userDocRef = doc(db, "users", userId);
          const userDoc = await getDoc(userDocRef);

          if (userDoc.exists() && userDoc.data().name) {
            const userName = userDoc.data().name;
            userInfo.innerHTML = `<i class="fas fa-user-circle mr-2 text-slate-400"></i> ${userName}`;
          } else {
            userInfo.innerHTML = `<i class="fas fa-user-circle mr-2 text-slate-400"></i> ID: ${userId.substring(
              0,
              8
            )}...`;
            nameModal.classList.remove("hidden");
          }
        } else {
          signInAnonymously(auth).catch(console.error);
        }
      });

      // MANEJADORES DE EVENTOS
      subjectButtons.forEach((button) => {
        button.addEventListener("click", () => {
          if (unsubscribeMessages) unsubscribeMessages();
          selectedSubject = button.dataset.subject;
          subjectButtons.forEach((btn) =>
            btn.classList.remove("ring-2", "ring-white/50", "scale-110")
          );
          button.classList.add("ring-2", "ring-white/50", "scale-110");
          startNewTopic(selectedSubject);
        });
      });

      promptCards.forEach((card) => {
        card.addEventListener("click", () => {
          const cardSubject = card.dataset.subject;
          if (cardSubject) {
            selectedSubject = cardSubject;
            subjectButtons.forEach((btn) => {
              btn.classList.remove("ring-2", "ring-white/50", "scale-110");
              if (btn.dataset.subject === cardSubject) {
                btn.classList.add("ring-2", "ring-white/50", "scale-110");
              }
            });
          }

          if (!selectedSubject) {
            alert(
              "¡Genial! Pero primero, por favor, selecciona una materia arriba para que pueda ayudarte mejor."
            );
            return;
          }
          const promptText = card.dataset.prompt;
          sendMessage(promptText);
        });
      });

      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const messageText = chatInput.value.trim();
        if (messageText && selectedSubject) {
          sendMessage(messageText);
          chatInput.value = "";
          chatInput.style.height = "auto";
        } else if (!selectedSubject) {
          alert("Por favor, selecciona una materia primero.");
        }
      });

      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          chatForm.querySelector('button[type="submit"]').click();
        }
      });

      chatInput.addEventListener("input", () => {
        chatInput.style.height = "auto";
        chatInput.style.height = chatInput.scrollHeight + "px";
      });

      newChatBtn.addEventListener("click", () => {
        if (unsubscribeMessages) unsubscribeMessages();
        selectedSubject = null;
        subjectButtons.forEach((btn) =>
          btn.classList.remove("ring-2", "ring-white/50", "scale-110")
        );
        chatContainer.innerHTML = "";
        chatContainer.appendChild(welcomeMessage);
        welcomeMessage.style.display = "block";
        currentChatId = null;
        resetProgress();
      });

      quizBtn.addEventListener("click", () => {
        if (!selectedSubject) {
          alert("Por favor, selecciona una materia primero.");
          return;
        }
        chatHistoryBeforeQuiz = chatContainer.innerHTML;
        quizModal.classList.remove("hidden");
      });

      generateQuizBtn.addEventListener("click", async () => {
        const topic = quizTopicInput.value.trim();
        if (!topic) {
          alert("Por favor, ingresa un tema para el quiz.");
          return;
        }

        quizModal.classList.add("hidden");
        quizTopicInput.value = "";
        await generateQuiz(topic);
      });

      cancelQuizBtn.addEventListener("click", () => {
        quizModal.classList.add("hidden");
        quizTopicInput.value = "";
      });

      // DELEGACIÓN DE EVENTOS MEJORADA - SOLUCIONADO
      chatContainer.addEventListener("click", (e) => {
        console.log("Event detected on:", e.target.className, e.target.id);

        // Manejar selección de opciones en quizzes
        if (e.target.classList.contains("quiz-option")) {
          console.log("Quiz option clicked");
          const questionIndex = parseInt(e.target.dataset.questionIndex);
          const optionIndex = parseInt(e.target.dataset.optionIndex);

          // Marcar la opción seleccionada
          document
            .querySelectorAll(
              `.quiz-option[data-question-index="${questionIndex}"]`
            )
            .forEach((opt) => {
              opt.classList.remove("selected");
            });
          e.target.classList.add("selected");

          // Guardar la respuesta del usuario
          userQuizAnswers[questionIndex] = optionIndex;
          console.log("User answers updated:", userQuizAnswers);
        }

        // Manejar envío de quiz
        if (e.target.id === "submit-quiz") {
          console.log("Submit quiz button clicked");
          e.preventDefault();
          e.stopPropagation();
          evaluateQuiz();
        }

        // Manejar nuevo quiz
        if (e.target.id === "new-quiz") {
          console.log("New quiz button clicked");
          e.preventDefault();
          e.stopPropagation();
          quizModal.classList.remove("hidden");
        }

        // Manejar volver al chat
        if (e.target.id === "back-to-chat") {
          console.log("Back to chat button clicked");
          e.preventDefault();
          e.stopPropagation();
          goBackToChat();
        }
      });

      if (menuToggle) {
        menuToggle.addEventListener("click", () => {
          sidebar.classList.toggle("hidden");
        });
      }

      nameForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const userName = nameInput.value.trim();
        if (userName && userId) {
          const userDocRef = doc(db, "users", userId);
          try {
            await setDoc(userDocRef, { name: userName }, { merge: true });
            userInfo.innerHTML = `<i class="fas fa-user-circle mr-2 text-slate-400"></i> ${userName}`;
            nameModal.classList.add("hidden");
          } catch (error) {
            console.error("Error saving name:", error);
            alert(
              "Hubo un error al guardar tu nombre. Por favor, inténtalo de nuevo."
            );
          }
        }
      });

      // FUNCIÓN PARA VOLVER AL CHAT
      function goBackToChat() {
        if (chatHistoryBeforeQuiz) {
          chatContainer.innerHTML = chatHistoryBeforeQuiz;
          chatHistoryBeforeQuiz = null;
        } else if (currentChatId) {
          loadMessages(currentChatId);
        } else {
          chatContainer.innerHTML = "";
          chatContainer.appendChild(welcomeMessage);
          welcomeMessage.style.display = "block";
        }
      }

      // FUNCIONES DE PROGRESO
      function updateProgress() {
        if (selectedSubject && progressIndicator) {
          progressIndicator.style.display = "flex";
          const progress = Math.min((interactionCount / 10) * 100, 100);
          progressBar.style.width = `${progress}%`;
          interactionCountElement.textContent = `${interactionCount} interacciones`;
        }
      }

      function resetProgress() {
        interactionCount = 0;
        if (progressIndicator) {
          progressIndicator.style.display = "none";
          progressBar.style.width = "0%";
        }
      }

      // FUNCIONES PRINCIPALES
      async function startNewTopic(subject) {
        conversationHistory = [];
        resetProgress();
        currentChatId = null;
        chatContainer.innerHTML = "";
        welcomeMessage.style.display = "none";

        const greetings = {
          Matemáticas:
            "¡Hola! Soy tu tutor de Matemáticas. ¿Listo para resolver algunos problemas? 📊",
          Ciencias:
            "¡Hola! Soy tu tutor de Ciencias. ¿Qué misterio del universo exploramos hoy? 🔬",
          Historia:
            "¡Hola! Soy tu tutor de Historia. ¡Viajemos en el tiempo! ¿Qué época te interesa? 🏛️",
          Literatura:
            "¡Hola! Soy tu tutor de Literatura. ¿Qué grandes historias y autores analizamos hoy? 📚",
          Inglés:
            "Hello! I am your English tutor. How can I help you improve your skills today? 🌍",
        };

        const greeting =
          greetings[subject] ||
          `¡Hola! Soy tu tutor de ${subject}. ¿En qué te puedo ayudar hoy?`;
        // Agregar el saludo al historial de conversación
        conversationHistory.push({ role: "model", text: greeting });
        addMessageToUI("model", greeting, true);

        try {
          if (userId) {
            const chatMeta = {
              userId,
              createdAt: serverTimestamp(),
              title: `${subject} - Nueva sesión`,
            };
            const chatRef = await addDoc(
              collection(db, `users/${userId}/chats`),
              chatMeta
            );
            currentChatId = chatRef.id;
            await addDoc(
              collection(db, `users/${userId}/chats/${currentChatId}/messages`),
              {
                role: "model",
                text: greeting,
                createdAt: serverTimestamp(),
              }
            );
            loadMessages(currentChatId);
          }
        } catch (error) {
          console.warn(
            "No se pudo guardar la conversación inicial en Firebase:",
            error
          );
        }
      }

      async function sendMessage(text) {
        if (!userId) return;
        // Agregar mensaje del usuario al historial
        conversationHistory.push({ role: "user", text: text });
        addMessageToUI("user", text);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        interactionCount++;
        updateProgress();

        if (!currentChatId) {
          const chatMeta = {
            userId: userId,
            createdAt: serverTimestamp(),
            title: `${selectedSubject}: ${text.substring(0, 25)}...`,
          };
          const chatRef = await addDoc(
            collection(db, `users/${userId}/chats`),
            chatMeta
          );
          currentChatId = chatRef.id;
          loadMessages(currentChatId);
        }

        await addDoc(
          collection(db, `users/${userId}/chats/${currentChatId}/messages`),
          {
            role: "user",
            text,
            createdAt: serverTimestamp(),
          }
        );

        const farewellWords = [
          "gracias",
          "adiós",
          "hasta luego",
          "nos vemos",
          "bye",
          "me voy",
          "hasta pronto",
        ];
        if (farewellWords.some((word) => text.toLowerCase().includes(word))) {
          addMessageToUI(
            "model",
            "¡Gracias a ti! ✨ Nos vemos pronto. ¡Mucho éxito en tus estudios! 🎓😊",
            true
          );
          return;
        }

        const typingIndicator = addTypingIndicator();
        chatContainer.scrollTop = chatContainer.scrollHeight;

        if (unsubscribeMessages) unsubscribeMessages();

        const aiResponseText = await getAiResponse(text);
        typingIndicator.remove();

        // Agregar respuesta del modelo al historial
        conversationHistory.push({ role: "model", text: aiResponseText });
        await addMessageToUI("model", aiResponseText, true);

        await addDoc(
          collection(db, `users/${userId}/chats/${currentChatId}/messages`),
          {
            role: "model",
            text: aiResponseText,
            createdAt: serverTimestamp(),
          }
        );

        loadMessages(currentChatId);
      }

      async function getAiResponse(userPrompt) {
        const systemPrompt = `Eres un super tutor empático y motivador especializado en ${selectedSubject} para estudiantes de secundaria.




### REGLAS PRINCIPALES ###
1. MANTENER EL CONTEXTO: Recuerda la conversación anterior y continúa naturalmente sin repetir saludos.
2. SALUDO ÚNICO: Saluda solo en el primer mensaje de la conversación, no en respuestas posteriores.
3. CONTINUIDAD: Si tu último mensaje terminó con una pregunta, continúa desde allí cuando el estudiante responda.
4. RESPUESTAS CONTEXTUALES: Responde basándote en el flujo de la conversación, no reinicies el tema.


### ESTILO DE COMUNICACIÓN ###
- Sé empático, motivador y amigable ✨😊
- Usa emojis con moderación 🎓📚
- Adapta el nivel al contexto de ${selectedSubject} de secundaria
- Si la pregunta es factual, responde directamente y luego añade contexto
- Si es de razonamiento, guía al estudiante con pistas, no des la respuesta inmediatamente


### FORMATO ESPECÍFICO PARA MATEMÁTICAS ###
- Usa superíndices Unicode: x², 5³
- Usa símbolos Unicode: √16, ³√27
- Usa × para multiplicación, ÷ para división
- Explica pasos con numeración o viñetas
### HISTORIAL DE CONVERSACIÓN ###
${conversationHistory
  .map((msg) => `${msg.role === "user" ? "ESTUDIANTE" : "TUTOR"}: ${msg.text}`)
  .join("\n")}


### INSTRUCCIÓN FINAL ###
Basándote en el historial anterior, responde apropiadamente al último mensaje del estudiante sin saludar de nuevo, manteniendo la continuidad de la conversación.
`;

        try {
          const response = await fetch(
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-Goog-Api-Key": GEMINI_API_KEY,
              },
              body: JSON.stringify({
                contents: [
                  { parts: [{ text: systemPrompt + "\n\n" + userPrompt }] },
                ],
                generationConfig: {
                  temperature: 0.7, // Valor moderado para equilibrio entre creatividad y consistencia
                  topP: 0.9,
                  topK: 40,
                },
              }),
            }
          );

          if (!response.ok)
            return "Lo siento, ocurrió un error al contactar con la IA.";
          const result = await response.json();
          return (
            result.candidates?.[0]?.content?.parts?.[0]?.text ||
            "No recibí respuesta del modelo."
          );
        } catch (error) {
          return "Hubo un problema de conexión. Por favor, inténtalo de nuevo.";
        }
      }

      async function generateQuiz(topic) {
        // Mostrar indicador de carga
        chatContainer.innerHTML =
          '<div class="text-center text-slate-400 py-8"><i class="fas fa-spinner fa-spin text-4xl mb-4"></i><p>Generando quiz, por favor espera...</p></div>';

        const systemPrompt = `Eres un tutor especializado en ${selectedSubject} para estudiantes de secundaria.
Tu tarea es generar un quiz de 10 preguntas de selección múltiple sobre el tema: "${topic}".


INSTRUCCIONES:
1. Genera EXACTAMENTE 10 preguntas.
2. Cada pregunta debe tener 4 opciones (a, b, c, d).
3. Marca la respuesta correcta indicando su índice (0-3).
4. El formato de respuesta debe ser un JSON válido con la siguiente estructura:
{
"title": "Quiz de [materia] sobre [tema]",
"questions": [
   {
       "question": "Texto de la pregunta 1",
       "options": ["Opción A", "Opción B", "Opción C", "Opción D"],
       "correctIndex": 0
   }
]
}
5. Asegúrate de que las preguntas sean apropiadas para estudiantes de secundaria.
6. Las preguntas deben ser claras y las opciones bien diferenciadas.
7. Devuelve SOLO el JSON, sin texto adicional.
8. Las respuestas correctas deben ser precisas.`;

        try {
          const response = await fetch(
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-Goog-Api-Key": GEMINI_API_KEY,
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text:
                          systemPrompt +
                          "\n\nPor favor, genera un quiz sobre: " +
                          topic,
                      },
                    ],
                  },
                ],
                generationConfig: {
                  temperature: 0.7,
                  maxOutputTokens: 2000,
                },
              }),
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            console.error("Error response from API:", errorData);
            chatContainer.innerHTML = "";
            addMessageToUI(
              "model",
              "Lo siento, ocurrió un error al generar el quiz. Por favor, inténtalo de nuevo más tarde."
            );
            return;
          }

          const result = await response.json();
          const responseText =
            result.candidates?.[0]?.content?.parts?.[0]?.text || "";

          // Limpiar la respuesta - eliminar markdown y obtener solo el JSON
          let cleanResponse = responseText.replace(/```json|```/g, "").trim();

          // Intentar extraer el JSON de la respuesta
          try {
            currentQuiz = JSON.parse(cleanResponse);
            displayQuiz(currentQuiz);
          } catch (e) {
            console.error(
              "Error parsing quiz JSON:",
              e,
              "Response:",
              responseText
            );

            // Intentar encontrar JSON dentro del texto si la parseo directo falla
            const jsonMatch = cleanResponse.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
              try {
                currentQuiz = JSON.parse(jsonMatch[0]);
                displayQuiz(currentQuiz);
              } catch (e2) {
                console.error("Second attempt to parse JSON failed:", e2);
                chatContainer.innerHTML = "";
                addMessageToUI(
                  "model",
                  "Lo siento, hubo un problema al procesar el quiz. Por favor, intenta con un tema diferente."
                );
              }
            } else {
              chatContainer.innerHTML = "";
              addMessageToUI(
                "model",
                "Lo siento, hubo un problema al generar el quiz. Por favor, intenta con un tema diferente."
              );
            }
          }
        } catch (error) {
          console.error("Error generating quiz:", error);
          chatContainer.innerHTML = "";
          addMessageToUI(
            "model",
            "Error de conexión. Por favor, inténtalo de nuevo."
          );
        }
      }

      // FUNCIÓN DISPLAYQUIZ - COMPLETAMENTE CORREGIDA
      function displayQuiz(quizData) {
        console.log("Displaying quiz with data:", quizData);

        // Limpiar el contenedor y reiniciar respuestas
        chatContainer.innerHTML = "";
        userQuizAnswers = {};

        const quizHTML = `
               <div class="glass-pane rounded-lg p-6 max-w-4xl mx-auto">
                   <h3 class="text-2xl font-bold mb-6 text-center text-indigo-400">${
                     quizData.title || "Quiz"
                   }</h3>
                   <div class="space-y-6">
                       ${quizData.questions
                         .map(
                           (question, qIndex) => `
                           <div class="quiz-container">
                               <div class="quiz-question text-lg mb-4 text-slate-100">${
                                 qIndex + 1
                               }. ${question.question}</div>
                               <div class="space-y-2">
                                   ${question.options
                                     .map(
                                       (option, oIndex) => `
                                       <button type="button"
                                               class="quiz-option w-full text-left p-3 rounded-lg transition-all duration-200 hover:bg-indigo-600/30 border border-slate-600 hover:border-indigo-400"
                                               data-question-index="${qIndex}"
                                               data-option-index="${oIndex}">
                                           <span class="font-semibold text-indigo-300">${String.fromCharCode(
                                             65 + oIndex
                                           )}.</span>
                                           <span class="ml-2">${option}</span>
                                       </button>
                                   `
                                     )
                                     .join("")}
                               </div>
                           </div>
                       `
                         )
                         .join("")}
                   </div>
                   <div class="mt-8 text-center">
                       <button id="submit-quiz"
                               class="px-8 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 rounded-lg font-semibold text-white shadow-lg transition-all duration-200 transform hover:scale-105">
                           <i class="fas fa-check mr-2"></i>Enviar Quiz
                       </button>
                   </div>
               </div>
           `;

        chatContainer.innerHTML = quizHTML;
        chatContainer.scrollTop = 0;

        console.log("Quiz displayed successfully");
      }

      // FUNCIÓN EVALUATEQUIZ - COMPLETAMENTE REESCRITA
      function evaluateQuiz() {
        console.log("Starting quiz evaluation...");
        console.log("Current quiz:", currentQuiz);
        console.log("User answers:", userQuizAnswers);

        if (!currentQuiz || !currentQuiz.questions) {
          console.error("No quiz data available");
          alert("Error: No hay datos del quiz disponibles");
          return;
        }

        const totalQuestions = currentQuiz.questions.length;
        const answeredQuestions = Object.keys(userQuizAnswers).length;

        console.log(`Total: ${totalQuestions}, Answered: ${answeredQuestions}`);

        if (answeredQuestions < totalQuestions) {
          alert(
            `Por favor, responde todas las preguntas. Has respondido ${answeredQuestions} de ${totalQuestions}.`
          );
          return;
        }

        let score = 0;
        const results = [];

        currentQuiz.questions.forEach((question, index) => {
          const userAnswer = userQuizAnswers[index];
          const isCorrect = userAnswer === question.correctIndex;

          if (isCorrect) score++;

          results.push({
            question: question.question,
            userAnswer:
              userAnswer !== undefined
                ? question.options[userAnswer]
                : "No respondida",
            correctAnswer: question.options[question.correctIndex],
            isCorrect: isCorrect,
          });

          console.log(
            `Q${index}: User=${userAnswer}, Correct=${question.correctIndex}, Result=${isCorrect}`
          );
        });

        console.log("Final score:", score, "of", totalQuestions);
        displayQuizResults(score, results, totalQuestions);
      }

      // FUNCIÓN DISPLAYQUIZRESULTS - COMPLETAMENTE REESCRITA
      function displayQuizResults(score, results, totalQuestions) {
        console.log(
          "Displaying results - Score:",
          score,
          "Total:",
          totalQuestions
        );

        const percentage = Math.round((score / totalQuestions) * 100);
        let performanceMessage, performanceColor, performanceIcon;

        if (percentage >= 90) {
          performanceMessage = "¡Excelente trabajo!";
          performanceColor = "text-green-400";
          performanceIcon = "🎉";
        } else if (percentage >= 70) {
          performanceMessage = "¡Buen trabajo!";
          performanceColor = "text-blue-400";
          performanceIcon = "👍";
        } else if (percentage >= 50) {
          performanceMessage = "Puedes mejorar";
          performanceColor = "text-yellow-400";
          performanceIcon = "📚";
        } else {
          performanceMessage = "Sigue practicando";
          performanceColor = "text-orange-400";
          performanceIcon = "💪";
        }

        const resultsHTML = `
               <div class="glass-pane rounded-lg p-6 max-w-4xl mx-auto">
                   <h3 class="text-2xl font-bold mb-6 text-center text-indigo-400">📊 Resultados del Quiz</h3>

                   <div class="text-center mb-8 p-6 bg-slate-700/50 rounded-lg border border-slate-600">
                       <div class="text-4xl font-bold ${performanceColor} mb-2">${score}/${totalQuestions}</div>
                       <div class="text-2xl ${performanceColor} mb-2">${percentage}%</div>
                       <div class="text-xl ${performanceColor} font-semibold">${performanceIcon} ${performanceMessage}</div>
                   </div>


                   <div class="space-y-4 mb-8">
                       ${results
                         .map(
                           (result, index) => `
                           <div class="p-4 rounded-lg border ${
                             result.isCorrect
                               ? "border-green-500/50 bg-green-500/10"
                               : "border-red-500/50 bg-red-500/10"
                           }">
                               <div class="font-semibold mb-2 text-slate-200">
                                   ${index + 1}. ${result.question}
                               </div>

                               <div class="mb-2">
                                   <span class="${
                                     result.isCorrect
                                       ? "text-green-400"
                                       : "text-red-400"
                                   } font-semibold">
                                       ${
                                         result.isCorrect
                                           ? "✅ Correcto"
                                           : "❌ Incorrecto"
                                       }
                                   </span>
                               </div>

                               <div class="text-sm space-y-1">
                                   <div class="text-slate-300">
                                       <strong>Tu respuesta:</strong> ${
                                         result.userAnswer
                                       }
                                   </div>
                                   ${
                                     !result.isCorrect
                                       ? `
                                       <div class="text-green-400">
                                           <strong>Respuesta correcta:</strong> ${result.correctAnswer}
                                       </div>
                                   `
                                       : ""
                                   }
                               </div>
                           </div>
                       `
                         )
                         .join("")}
                   </div>


                   <div class="flex flex-col sm:flex-row justify-center gap-4">
                       <button id="new-quiz"
                               class="px-6 py-3 bg-purple-600 hover:bg-purple-500 rounded-lg font-semibold transition-colors duration-200 flex items-center justify-center">
                           <i class="fas fa-redo mr-2"></i>Nuevo Quiz
                       </button>
                       <button id="back-to-chat"
                               class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-semibold transition-colors duration-200 flex items-center justify-center">
                           <i class="fas fa-arrow-left mr-2"></i>Volver al Chat
                       </button>
                   </div>
               </div>
           `;

        chatContainer.innerHTML = resultsHTML;
        chatContainer.scrollTop = 0;

        console.log("Results displayed successfully");
      }

      // FUNCIONES DE LA INTERFAZ
      function addMessageToUI(sender, text, useTypingEffect = false) {
        return new Promise((resolve) => {
          const messageWrapper = createMessageElement(sender, text);
          chatContainer.appendChild(messageWrapper);

          const textElement = messageWrapper.querySelector(".text-content");

          if (sender === "model" && useTypingEffect) {
            isTypingEffectInProgress = true;
            let i = 0;
            textElement.innerHTML = "";
            const interval = setInterval(() => {
              if (i < text.length) {
                textElement.innerHTML += text.charAt(i).replace(/\n/g, "<br>");
                i++;
                chatContainer.scrollTop = chatContainer.scrollHeight;
              } else {
                clearInterval(interval);
                isTypingEffectInProgress = false;
                if (selectedSubject)
                  addSuggestionChip(messageWrapper, selectedSubject);
                resolve();
              }
            }, 30);
          } else {
            textElement.innerHTML = text.replace(/\n/g, "<br>");
            resolve();
          }

          chatContainer.scrollTop = chatContainer.scrollHeight;
        });
      }

      function createMessageElement(sender, text) {
        const messageWrapper = document.createElement("div");
        messageWrapper.className = `flex w-full mb-4 animate-slide-up ${
          sender === "user" ? "justify-end" : "justify-start items-end gap-2"
        }`;

        const isModel = sender === "model";
        const avatar = isModel
          ? `<div class="w-8 h-8 rounded-full bg-indigo-500 flex-shrink-0 flex items-center justify-center shadow-md"><i class="fas fa-brain text-white text-sm"></i></div>`
          : "";

        messageWrapper.innerHTML = `
           ${avatar}
           <div class="max-w-[85%] md:max-w-[75%]">
               <div class="p-3 md:p-4 rounded-2xl shadow-lg glass-pane ${
                 sender === "user"
                   ? "bg-indigo-600 text-white rounded-br-none"
                   : "bg-slate-700/80 text-slate-200 rounded-bl-none"
               }">
                   <div class="text-sm md:text-base text-content"></div>
               </div>
               <div class="suggestion-container mt-2 flex flex-wrap gap-2"></div>
           </div>
       `;
        return messageWrapper;
      }

      function addTypingIndicator() {
        const indicator = createMessageElement("model", "");
        indicator.querySelector(".text-content").innerHTML =
          '<div class="typing-indicator"><span></span><span></span><span></span></div>';
        chatContainer.appendChild(indicator);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return indicator;
      }

      function addSuggestionChip(messageWrapper, subject) {
        const farewellWords = [
          "gracias",
          "adiós",
          "hasta luego",
          "nos vemos",
          "bye",
          "me voy",
          "hasta pronto",
          "éxito",
        ];
        const lastMessageText = messageWrapper
          .querySelector(".text-content")
          .textContent.toLowerCase();
        if (farewellWords.some((word) => lastMessageText.includes(word))) {
          return;
        }

        const suggestionContainer = messageWrapper.querySelector(
          ".suggestion-container"
        );
        if (!suggestionContainer) return;

        const suggestionText = generatePracticeExercise(subject);
        const chip = document.createElement("button");
        chip.className =
          "suggestion-chip text-xs px-3 py-1 rounded-full animate-fade-in";
        chip.textContent = suggestionText;
        suggestionContainer.appendChild(chip);
      }

      function loadChatHistory() {
        const q = query(
          collection(db, `users/${userId}/chats`),
          orderBy("createdAt", "desc")
        );
        onSnapshot(q, (snapshot) => {
          historyContainer.innerHTML = "";
          snapshot.docs.forEach((doc) => {
            const chat = doc.data();
            const historyItem = document.createElement("button");
            historyItem.className =
              "w-full text-left p-3 rounded-lg hover:bg-slate-700 truncate transition-colors text-sm text-slate-300";
            historyItem.textContent = chat.title || "Chat sin título";
            historyItem.dataset.chatId = doc.id;
            historyItem.addEventListener("click", () => {
              if (unsubscribeMessages) unsubscribeMessages();
              currentChatId = doc.id;
              loadMessages(currentChatId);
            });
            historyContainer.appendChild(historyItem);
          });
        });
      }

      function loadMessages(chatId) {
        if (isTypingEffectInProgress) return;

        if (welcomeMessage) welcomeMessage.style.display = "none";
        chatContainer.innerHTML =
          '<div class="text-center text-slate-400">Cargando mensajes...</div>';
        resetProgress();

        const messagesQuery = query(
          collection(db, `users/${userId}/chats/${chatId}/messages`),
          orderBy("createdAt")
        );
        unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
          if (isTypingEffectInProgress) return;

          chatContainer.innerHTML = "";
          const messages = snapshot.docs.map((doc) => doc.data());
          interactionCount = Math.floor(
            messages.filter((msg) => msg.role === "user").length
          );
          updateProgress();

          messages.forEach((msg) => {
            addMessageToUI(msg.role, msg.text, false);
          });
        });
      }
    </script>
  </body>
</html>
